<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>工場DX - マーカーレス空間誘導</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        /* AR開始前のボタンを少し見やすく */
        .a-enter-vr-button { background-color: #007bff !important; }
    </style>
</head>
<body>
    <a-scene 
        webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay, spatial-tracking;"
        renderer="alpha: true; antialias: true; colorManagement: true;"
        xr-mode-ui="enabled: true">

        <a-sky visible="false"></a-sky>

        <a-entity id="reticle" visible="false">
            <a-ring color="#00ff00" radius-inner="0.1" radius-outer="0.15" rotation="-90 0 0"></a-ring>
            <a-circle color="#00ff00" radius="0.02" rotation="-90 0 0" opacity="0.5"></a-circle>
        </a-entity>

        <a-entity id="factory-content" visible="false">
            <a-entity position="1 0 -2">
                <a-box color="red" width="0.5" height="1.8" depth="0.5" opacity="0.7"></a-box>
                <a-text value="SHELF A" position="0 2 0" align="center" scale="2 2 2"></a-text>
                <a-triangle color="red" rotation="-90 0 0" scale="0.5 0.5 0.5" position="0 0.01 0.5"
                            animation="property: position; to: 0 0.01 1; dir: alternate; dur: 1000; loop: true">
                </a-triangle>
            </a-entity>

            <a-entity position="-1 0 -4">
                <a-box color="blue" width="0.5" height="1.8" depth="0.5" opacity="0.7"></a-box>
                <a-text value="SHELF B" position="0 2 0" align="center" scale="2 2 2"></a-text>
            </a-entity>
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const scene = document.querySelector('a-scene');
        const reticle = document.querySelector('#reticle');
        const content = document.querySelector('#factory-content');
        let hitTestSource = null;

        // ARセッションが開始された時の処理
        scene.addEventListener('enter-vr', () => {
            if (!scene.is('ar-mode')) return;

            const session = scene.xrSession;
            session.requestReferenceSpace('viewer').then((space) => {
                session.requestHitTestSource({ space: space }).then((source) => {
                    hitTestSource = source;
                });
            });

            // 画面（トリガー）がクリックされたら、その場所にコンテンツを固定
            session.addEventListener('select', () => {
                if (reticle.getAttribute('visible')) {
                    // レティクルの現在の位置にコンテンツを移動
                    content.setAttribute('position', reticle.getAttribute('position'));
                    content.setAttribute('rotation', reticle.getAttribute('rotation'));
                    content.setAttribute('visible', true);
                    // 設置した後はレティクルを消す（任意）
                    // hitTestSource = null; 
                    // reticle.setAttribute('visible', false);
                }
            });
        });

        // 毎フレームの処理（床を探してレティクルを動かす）
        scene.addEventListener('render-target-loaded', () => {
            scene.renderer.setAnimationLoop((time, frame) => {
                if (!frame || !hitTestSource) return;

                const session = scene.xrSession;
                const hitTestResults = frame.getHitTestResults(hitTestSource);

                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const referenceSpace = scene.renderer.xr.getReferenceSpace();
                    const pose = hit.getPose(referenceSpace);

                    reticle.setAttribute('visible', true);
                    reticle.setAttribute('position', pose.transform.position);
                    reticle.object3D.quaternion.copy(pose.transform.orientation);
                } else {
                    reticle.setAttribute('visible', false);
                }
            });
        });
    </script>
</body>
</html>