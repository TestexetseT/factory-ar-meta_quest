<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>工場DX - デバッグ版</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene 
        webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay, spatial-tracking;"
        renderer="alpha: true; antialias: true;"
        xr-mode-ui="enabled: true">

        <a-sky visible="false"></a-sky>

        <a-text id="statusText" value="Status: Waiting for AR..." 
                position="0 1.5 -1" align="center" color="yellow" width="3"></a-text>

        <a-entity id="reticle" visible="false">
            <a-ring color="#00ff00" radius-inner="0.08" radius-outer="0.12" rotation="-90 0 0"></a-ring>
        </a-entity>

        <a-entity id="factory-content" visible="false">
            <a-box color="red" width="0.4" height="1.5" depth="0.4" opacity="0.7" position="1 0.75 -2"></a-box>
            <a-text value="SHELF A" position="1 1.7 -2" align="center"></a-text>
        </a-entity>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        const statusText = document.querySelector('#statusText');
        const reticle = document.querySelector('#reticle');
        const content = document.querySelector('#factory-content');
        const scene = document.querySelector('a-scene');
        let hitTestSource = null;

        scene.addEventListener('enter-vr', () => {
            if (!scene.is('ar-mode')) return;
            statusText.setAttribute('value', 'Status: Scanning floor...');

            const session = scene.xrSession;
            session.requestReferenceSpace('viewer').then((space) => {
                session.requestHitTestSource({ space: space }).then((source) => {
                    hitTestSource = source;
                    statusText.setAttribute('value', 'Status: Look at floor');
                });
            });

            session.addEventListener('select', () => {
                if (reticle.getAttribute('visible')) {
                    content.setAttribute('position', reticle.getAttribute('position'));
                    content.setAttribute('visible', true);
                    statusText.setAttribute('value', 'Status: Placed!');
                }
            });
        });

        scene.addEventListener('render-target-loaded', () => {
            scene.renderer.setAnimationLoop((time, frame) => {
                if (!frame || !hitTestSource) return;

                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const referenceSpace = scene.renderer.xr.getReferenceSpace();
                    const pose = hit.getPose(referenceSpace);

                    reticle.setAttribute('visible', true);
                    reticle.setAttribute('position', pose.transform.position);
                    reticle.object3D.quaternion.copy(pose.transform.orientation);
                    
                    // 床が見つかっている間だけ表示
                    if(statusText.getAttribute('value').includes('Scanning')) {
                        statusText.setAttribute('value', 'Status: Floor Found! Trigger to place');
                    }
                } else {
                    reticle.setAttribute('visible', false);
                }
            });
        });
    </script>
</body>
</html>
